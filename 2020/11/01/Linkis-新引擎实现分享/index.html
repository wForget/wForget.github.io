<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="nPT3ONUGntVHfQCZH2D5GcUMgg5DH4IReN4GIs0GrW8" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linkis," />










<meta name="description" content="Linkis 新引擎实现分享在社区大佬的帮助下，我们完成了 0.11 版本的开发，实现了 ElasticSearch 和 Presto 引擎。具体的开发文档可以参考： Linkis引擎开发文档  执行引擎架构的选择目前 Linkis 的架构可以分为两种，一种是 Entrance-EngineManger-Engine 的模式，一种是 Entrance 模式。统一执行服务的架构可以参考官方文档： L">
<meta property="og:type" content="article">
<meta property="og:title" content="Linkis 新引擎实现分享">
<meta property="og:url" content="https://wforget.github.io/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/index.html">
<meta property="og:site_name" content="wForget&#39;s blog">
<meta property="og:description" content="Linkis 新引擎实现分享在社区大佬的帮助下，我们完成了 0.11 版本的开发，实现了 ElasticSearch 和 Presto 引擎。具体的开发文档可以参考： Linkis引擎开发文档  执行引擎架构的选择目前 Linkis 的架构可以分为两种，一种是 Entrance-EngineManger-Engine 的模式，一种是 Entrance 模式。统一执行服务的架构可以参考官方文档： L">
<meta property="og:locale">
<meta property="og:image" content="https://wforget.github.io/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/ElasticSearch%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="https://wforget.github.io/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/Es%E5%BC%95%E6%93%8E%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png">
<meta property="article:published_time" content="2020-11-01T12:34:12.000Z">
<meta property="article:modified_time" content="2022-10-18T12:17:03.798Z">
<meta property="article:author" content="wangz">
<meta property="article:tag" content="Linkis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wforget.github.io/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/ElasticSearch%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%9B%BE.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wforget.github.io/2020/11/01/Linkis-新引擎实现分享/"/>





  <title>Linkis 新引擎实现分享 | wForget's blog</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wForget's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linkis 新引擎实现分享</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-01T20:34:12+08:00">
                2020-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Linkis-新引擎实现分享"><a href="#Linkis-新引擎实现分享" class="headerlink" title="Linkis 新引擎实现分享"></a>Linkis 新引擎实现分享</h3><p>在社区大佬的帮助下，我们完成了 0.11 版本的开发，实现了 ElasticSearch 和 Presto 引擎。具体的开发文档可以参考： <a target="_blank" rel="noopener" href="https://github.com/WeBankFinTech/Linkis/wiki/Linkis%E5%BC%95%E6%93%8E%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3">Linkis引擎开发文档</a> </p>
<h3 id="执行引擎架构的选择"><a href="#执行引擎架构的选择" class="headerlink" title="执行引擎架构的选择"></a>执行引擎架构的选择</h3><p>目前 Linkis 的架构可以分为两种，一种是 Entrance-EngineManger-Engine 的模式，一种是 Entrance 模式。统一执行服务的架构可以参考官方文档： <a target="_blank" rel="noopener" href="https://github.com/WeBankFinTech/Linkis/wiki/Linkis-UJES%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3">Linkis-UJES设计文档</a> </p>
<p>Entrance 服务作为执行的入口，主要负责任务的持久化工作，日志的输出，进行脚本的校验和变量替换，并与 Engine、EngineManager 服务交互，向可用的 Engine 发送执行任务的请求，或者向 EngineManager 发送启动 Engine 的请求。</p>
<p>EngineManager 服务主要负责 Engine 的启动，进行 Engine 请求资源的请求与释放，并持续监控 Engine 的状态。</p>
<p>Engine 服务负责任务的具体执行，包括了任务执行的一些初始化操作、任务脚本的切分、任务的执行、任务的进度监控和结果集的保存等工作。</p>
<p>Spark、Hive 引擎是 Entrance-EngineManger-Engine 模式实现，在这个模式中 Engine 作为 Spark 、Hive 任务的 Driver 端，向外暴露接口可持续的接受 Entrance 发来的请求，完成任务的执行。这个模式中不仅实现了多租户的任务隔离，还提供了单用户的引擎复用，尽量减少 Engine 的启动，大大提高了执行的效率。</p>
<p>上面的各个服务可以看到每个服务的职责非常的明确，不过多个服务也让整个的架构变的比较重，有一些轻量的执行没有必要通过 Entrance-EngineManger-Engine 模式进行实现。例如 Linkis JDBC 引擎的实现就是通过 Entrance 的模式。JDBC 引擎的职责就是作为 JDBC 连接的客户端向服务端发送请求，并进行连接的维护。JDBC 连接的维护是比较轻量级的，而且 JDBC 连接的复用也不是根据平台用户进行区分的，所以单独为每个用户启动一个引擎是没有必要的。</p>
<p>ElasticSearch 和 Presto 的客户端实际上就是 Http Client，所以 ElasticSearch 和 Presto 引擎的实现也应该是比较轻量的，最终我们实现的 ElasticSearch 和 Presto 引擎也是通过 Entrance 的模式实现的。</p>
<h3 id="引擎资源控制"><a href="#引擎资源控制" class="headerlink" title="引擎资源控制"></a>引擎资源控制</h3><p>Linkis 的资源管理服务，用来管理用户、系统的资源和并发的控制，实现新的引擎需要考虑到引擎资源相关接口的实现。具体架构可参考：<a target="_blank" rel="noopener" href="https://github.com/WeBankFinTech/Linkis/wiki/Linkis-RM%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3">Linkis RM设计文档</a></p>
<h4 id="Entrance-EngineManger-Engine-模式资源控制"><a href="#Entrance-EngineManger-Engine-模式资源控制" class="headerlink" title="Entrance-EngineManger-Engine 模式资源控制"></a>Entrance-EngineManger-Engine 模式资源控制</h4><p>Entrance-EngineManger-Engine 的模式，资源相关主要需要下面两个实现：</p>
<ol>
<li>EngineManger 注册资源<br>Linkis RM设计文档中可以看到，EngineManger 作为 Engine 资源的管理者，需要先向 ResourceManger 进行管理资源的注册。<br>Linkis 已经将 EngineManger 注册资源的逻辑进行了抽象，实现的时候只需要在  SpringConfiguration 中进行配置创建 resources 的 spring bean 对象，可以参考 SparkEngineManagerSpringConfiguration 的实现。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.enginemanager.configuration.SparkEngineManagerSpringConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SparkEngineManagerSpringConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(<span class="type">Array</span>(<span class="string">&quot;resources&quot;</span>))</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createResource</span></span>(): <span class="type">ModuleInfo</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> totalResource = <span class="keyword">new</span> <span class="type">DriverAndYarnResource</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="type">LoadInstanceResource</span>(<span class="type">ENGINE_MANAGER_MAX_MEMORY_AVAILABLE</span>.getValue.toLong,</span><br><span class="line">        <span class="type">ENGINE_MANAGER_MAX_CORES_AVAILABLE</span>.getValue, <span class="type">ENGINE_MANAGER_MAX_CREATE_INSTANCES</span>.getValue),</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> protectedResource = <span class="keyword">new</span> <span class="type">DriverAndYarnResource</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="type">LoadInstanceResource</span>(<span class="type">ENGINE_MANAGER_PROTECTED_MEMORY</span>.getValue.toLong, <span class="type">ENGINE_MANAGER_PROTECTED_CORES</span>.getValue,</span><br><span class="line">        <span class="type">ENGINE_MANAGER_PROTECTED_INSTANCES</span>.getValue),</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="type">ModuleInfo</span>(<span class="type">Sender</span>.getThisServiceInstance, totalResource, protectedResource, <span class="type">ResourceRequestPolicy</span>.<span class="type">DriverAndYarn</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>EngineResourceFactory 实现<br>EngineManager 创建 Engine 的时候需要先向 ResourceManger 去请求资源，所以新引擎需要提供 EngineResourceFactory 的实现，用来初始化创新 Engine 所需要的资源，再向 ResourceManger 进行请求。<br>Linkis 中提供了 AbstractEngineResourceFactory 的抽象，实现的时候只需要从 AbstractEngineResourceFactory 继承。具体可参考 SparkEngineResourceFactory 的实现：</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.enginemanager.configuration.SparkEngineResourceFactory</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">&quot;engineResourceFactory&quot;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SparkEngineResourceFactory</span> <span class="keyword">extends</span> <span class="title">AbstractEngineResourceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">getRequestResource</span></span>(properties: java.util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]): <span class="type">DriverAndYarnResource</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> executorNum = <span class="type">DWC_SPARK_EXECUTOR_INSTANCES</span>.getValue(properties)</span><br><span class="line">    <span class="keyword">new</span> <span class="type">DriverAndYarnResource</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="type">LoadInstanceResource</span>(<span class="type">ByteTimeUtils</span>.byteStringAsBytes(<span class="type">DWC_SPARK_DRIVER_MEMORY</span>.getValue(properties) + <span class="string">&quot;G&quot;</span>),</span><br><span class="line">        <span class="type">DWC_SPARK_DRIVER_CORES</span>,</span><br><span class="line">        <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="type">YarnResource</span>(<span class="type">ByteTimeUtils</span>.byteStringAsBytes(<span class="type">DWC_SPARK_EXECUTOR_MEMORY</span>.getValue(properties) * executorNum + <span class="string">&quot;G&quot;</span>),</span><br><span class="line">        <span class="type">DWC_SPARK_EXECUTOR_CORES</span>.getValue(properties) * executorNum,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="type">DWC_QUEUE_NAME</span>.getValue(properties))</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Entrance-模式并发控制"><a href="#Entrance-模式并发控制" class="headerlink" title="Entrance 模式并发控制"></a>Entrance 模式并发控制</h4><p>Lnkis 中将 Engine 的实例数作为资源的一种，目前用户请求的并发是通过 Engine 的实例数进行控制的，那么在 Entrance 的模式下，就没有很好的对用户的并发进行控制。</p>
<p>在 ElasticSearch 和 Presto 的实现中，我们参考了 EngineManager 的资源控制，将并发数作为资源的一种，在 Entrance 启动时进行模块资源注册。将每个执行作为一个实例，执行发生时先进行资源的请求和锁定，执行完成后进行资源的释放，从而达到用户并发的控制。</p>
<p>主要包括了以下步骤：</p>
<ol>
<li>Entrance 注册并发资源<br>Entrance 注册并发资源，需要创建资源实例，将并发作为资源的一部分，然后配合 @EnableResourceManager 和 @RegisterResource 注解进行资源注册。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义资源</span></span><br><span class="line"><span class="meta">@Bean</span>(<span class="type">Array</span>(<span class="string">&quot;resources&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createResource</span></span>(): <span class="type">ModuleInfo</span> = &#123;</span><br><span class="line">  <span class="comment">// 创建并发资源实例，分为总资源和受保护的资源</span></span><br><span class="line">  <span class="keyword">val</span> totalResource = <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="type">EsEntranceConfiguration</span>.<span class="type">ENTRANCE_MAX_JOB_INSTANCE</span>.getValue)</span><br><span class="line">  <span class="keyword">val</span> protectResource = <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="type">EsEntranceConfiguration</span>.<span class="type">ENTRANCE_PROTECTED_JOB_INSTANCE</span>.getValue)</span><br><span class="line">  info(<span class="string">s&quot;create resource for es engine totalResource is <span class="subst">$totalResource</span>, protectResource is <span class="subst">$protectResource</span>&quot;</span>)</span><br><span class="line">  <span class="type">ModuleInfo</span>(<span class="type">Sender</span>.getThisServiceInstance, totalResource, protectResource, <span class="type">ResourceRequestPolicy</span>.<span class="type">Instance</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册资源</span></span><br><span class="line"><span class="meta">@RegisterResource</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">registerResources</span></span>(): <span class="type">ModuleInfo</span> = resources</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行前请求锁定资源<br>执行实例初始化前，先通过 ResourceManagerClient#requestResource 方法请求锁定并发实例资源。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rmClient.requestResource(requestEngine.user, requestEngine.creator, <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="number">1</span>)) <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">NotEnoughResource</span>(reason) =&gt;</span><br><span class="line">    <span class="comment">// 没有请求到资源，抛出异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="type">EsEngineException</span>(<span class="type">LogUtils</span>.generateWarn(reason))</span><br><span class="line">  <span class="keyword">case</span> <span class="type">AvailableResource</span>(ticketId) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 请求到资源，创建执行实例，并保存 ticketId 用于释放资源</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 当资源被实例化后，返回实际占用的资源总量</span></span><br><span class="line">    rmClient.resourceInited(<span class="type">UserResultResource</span>(ticketId, requestEngine.user), <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="number">1</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行完成释放资源<br>执行完成后销毁执行实例，并通过 ResourceManagerClient#resourceReleased 方法释放锁定的资源。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 ticketId 释放对应的资源</span></span><br><span class="line">rmClient.resourceReleased(<span class="type">UserResultResource</span>(ticketId, requestEngine.user))</span><br></pre></td></tr></table></figure>


<h3 id="ElasticSearch-引擎的实现"><a href="#ElasticSearch-引擎的实现" class="headerlink" title="ElasticSearch 引擎的实现"></a>ElasticSearch 引擎的实现</h3><p>下面是微众王和平大佬帮忙画的 ElasticSearch 引擎整体的架构图：</p>
<img src="/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/ElasticSearch%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%9B%BE.png" class="" title="ElasticSearch引擎架构图">

<p>Linkis 新引擎的实现还是比较容易的，ElasticSearch 引擎的代码结构如下，整体的代码量也是比较少。主要包括了资源的配置、执行器的实例化和ElasticSearch请求与结果解析的相关代码。</p>
<img src="/2020/11/01/Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB/Es%E5%BC%95%E6%93%8E%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png" class="" title="Es引擎代码结构">

<ol>
<li>资源注册<br>ElasticSearch 引擎需要考虑到用户请求的并发和 Entrance 整体并发的控制。<br>Entrance 启动时，需要对 Entrance 可用资源进行注册，主要包括了最大实例数和保护的阈值。在 EsSpringConfiguration 中生成资源的 bean 对象，并传入 EsEngineManager 进行注册，配置 @EnableResourceManager 和 @RegisterResource 就会自动进行注册。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.entrance.conf.EsSpringConfiguration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsSpringConfiguration</span> <span class="keyword">extends</span> <span class="title">Logging</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(<span class="type">Array</span>(<span class="string">&quot;resources&quot;</span>))</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createResource</span></span>(<span class="meta">@Autowired</span> rmClient: <span class="type">ResourceManagerClient</span>): <span class="type">ModuleInfo</span> = &#123;</span><br><span class="line">    <span class="comment">// Clean up resources before creating resources to prevent dirty data when exiting abnormally (创造资源之前进行资源清理，防止异常退出时产生了脏数据)</span></span><br><span class="line">    <span class="type">Utils</span>.tryQuietly(rmClient.unregister())</span><br><span class="line">    <span class="type">Utils</span>.addShutdownHook(&#123;</span><br><span class="line">      info(<span class="string">&quot;rmClient shutdown, unregister resource...&quot;</span>)</span><br><span class="line">      rmClient.unregister</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">val</span> totalResource = <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="type">EsEntranceConfiguration</span>.<span class="type">ENTRANCE_MAX_JOB_INSTANCE</span>.getValue)</span><br><span class="line">    <span class="keyword">val</span> protectResource = <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="type">EsEntranceConfiguration</span>.<span class="type">ENTRANCE_PROTECTED_JOB_INSTANCE</span>.getValue)</span><br><span class="line">    info(<span class="string">s&quot;create resource for es engine totalResource is <span class="subst">$totalResource</span>, protectResource is <span class="subst">$protectResource</span>&quot;</span>)</span><br><span class="line">    <span class="type">ModuleInfo</span>(<span class="type">Sender</span>.getThisServiceInstance, totalResource, protectResource, <span class="type">ResourceRequestPolicy</span>.<span class="type">Instance</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.entrance.execute.EsEngineManager</span></span><br><span class="line"><span class="meta">@EnableResourceManager</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEngineManager</span>(<span class="params">resources: <span class="type">ModuleInfo</span></span>) <span class="keyword">extends</span> <span class="title">EngineManager</span> <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RegisterResource</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">registerResources</span></span>(): <span class="type">ModuleInfo</span> = resources</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>请求执行器<br>EsEngineRequester 启动一个执行器，用于任务的执行，通过 request 方法对传入的 job 生成一个执行的 EsEntranceEngine，请求时先向 ResourceManager 请求并锁定一个实例的资源，在 EsEntranceEngine 执行结束后会进行释放。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.entrance.execute.EsEngineRequester</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEngineRequester</span>(<span class="params">groupFactory: <span class="type">GroupFactory</span>, rmClient: <span class="type">ResourceManagerClient</span></span>) <span class="keyword">extends</span> <span class="title">EngineRequester</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span></span>(job: <span class="type">Job</span>): <span class="type">Option</span>[<span class="type">EntranceEngine</span>] = job <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> entranceJob: <span class="type">EntranceJob</span> =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> requestEngine = createRequestEngine(job);</span><br><span class="line">      <span class="comment">// request resource manager</span></span><br><span class="line">      rmClient.requestResource(requestEngine.user, requestEngine.creator, <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="number">1</span>)) <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">NotEnoughResource</span>(reason) =&gt;</span><br><span class="line">          <span class="keyword">throw</span> <span class="type">EsEngineException</span>(<span class="type">LogUtils</span>.generateWarn(reason))</span><br><span class="line">        <span class="keyword">case</span> <span class="type">AvailableResource</span>(ticketId) =&gt; &#123;</span><br><span class="line">          <span class="keyword">val</span> engine = <span class="keyword">new</span> <span class="type">EsEntranceEngine</span>(idGenerator.incrementAndGet(), <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>](requestEngine.properties)</span><br><span class="line">            , () =&gt; &#123;rmClient.resourceReleased(<span class="type">UserResultResource</span>(ticketId, requestEngine.user))&#125;)</span><br><span class="line">          engine.setGroup(groupFactory.getOrCreateGroup(getGroupName(requestEngine.creator, requestEngine.user)))</span><br><span class="line">          engine.setUser(requestEngine.user)</span><br><span class="line">          engine.setCreator(requestEngine.creator)</span><br><span class="line"><span class="comment">//          engine.updateState(ExecutorState.Starting, ExecutorState.Idle, null, null)</span></span><br><span class="line">          engine.setJob(entranceJob)</span><br><span class="line">          engine.init()</span><br><span class="line">          executorListener.foreach(_.onExecutorCreated(engine))</span><br><span class="line">          rmClient.resourceInited(<span class="type">UserResultResource</span>(ticketId, requestEngine.user), <span class="keyword">new</span> <span class="type">InstanceResource</span>(<span class="number">1</span>))</span><br><span class="line">          <span class="type">Option</span>(engine)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; <span class="type">None</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// com.webank.wedatasphere.linkis.entrance.execute.EsEntranceEngine</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEntranceEngine</span>(<span class="params">id: <span class="type">Long</span>, properties: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">String</span>], resourceRelease: (</span>) <span class="title">=&gt;</span> <span class="title">Unit</span>) <span class="keyword">extends</span> <span class="title">EntranceEngine</span>(<span class="params">id</span>) <span class="keyword">with</span> <span class="title">SingleTaskOperateSupport</span> <span class="keyword">with</span> <span class="title">SingleTaskInfoSupport</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">close</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.job.setResultSize(<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">this</span>.engineExecutor.close</span><br><span class="line">      <span class="comment">// 释放资源</span></span><br><span class="line">      resourceRelease()</span><br><span class="line">      <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>任务执行<br>EsEntranceEngine 是 com.webank.wedatasphere.linkis.entrance.execute.EntranceEngine 的实现，进行脚本的执行。在这里抽出一层 EsEngineExecutor 作为 Es 任务的具体执行。EsEntranceEngine 则负责 EsEngineExecutor 的初始化、脚本解析切分等实现。</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEntranceEngine</span>(<span class="params">id: <span class="type">Long</span>, properties: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">String</span>], resourceRelease: (</span>) <span class="title">=&gt;</span> <span class="title">Unit</span>) <span class="keyword">extends</span> <span class="title">EntranceEngine</span>(<span class="params">id</span>) <span class="keyword">with</span> <span class="title">SingleTaskOperateSupport</span> <span class="keyword">with</span> <span class="title">SingleTaskInfoSupport</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> engineExecutor: <span class="type">EsEngineExecutor</span> = _</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span>(executeRequest: <span class="type">ExecuteRequest</span>): <span class="type">ExecuteResponse</span>   <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">executeLine</span></span>(code: <span class="type">String</span>): <span class="type">ExecuteResponse</span> = <span class="keyword">this</span>.engineExecutor.executeLine(code, storePath, <span class="string">s&quot;_<span class="subst">$codeLine</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ElasticSearch 脚本执行<br>entrance.executor 包中就是 ElasticSearch 客户端的封装、请求的封装和结果的解析等相关代码。<br>ElasticSearch 客户端封装在 EsClient 中，通过 EsClientFactory 进行实例化，并将 datasourceName 作为唯一 Key 进行缓存。<br>EsEngineExecutorImpl 是 EsEngineExecutor 的实现，用于任务的执行。<br>ResponseHandlerImpl 用于结果的处理，会根据 ElasticSearch 的返回类型进行反序列化，并保存为 Linkis 的 ResultSet。</li>
</ol>
<h3 id="DataSource-路由"><a href="#DataSource-路由" class="headerlink" title="DataSource 路由"></a>DataSource 路由</h3><p>在与微众大佬的讨论交流中得知后面 Linkis 的架构将会引入 DataSource 的概念，DataSource 模块维护引擎的连接信息和集群等信息，可以减少一些数据源运行配置，方便数据源配置和权限管理，为数据平台提供元数据信息，并可根据 DataSource 进行路由实现多集群的路由。</p>
<p>在 Linkis-0.11.0版本中添加了 linkis-gateway-ujes-datasource-ruler 模块，作为一个 Gateway 插件的形式简单实现了，请求和 Entrance 的路由。</p>
<h4 id="linkis-gateway-ujes-datasource-ruler-模块的实现"><a href="#linkis-gateway-ujes-datasource-ruler-模块的实现" class="headerlink" title="linkis-gateway-ujes-datasource-ruler 模块的实现"></a>linkis-gateway-ujes-datasource-ruler 模块的实现</h4><p>抽象出 EntranceGatewayRouterRuler 接口用于执行路由规则，在 Gateway 模块的 EntranceGatewayRouter 中注入 EntranceGatewayRouterRuler 实例。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntranceGatewayRouter</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayRouter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span>(required = <span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> rules: <span class="type">Array</span>[<span class="type">EntranceGatewayRouterRuler</span>] = _</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">route</span></span>(gatewayContext: <span class="type">GatewayContext</span>): <span class="type">ServiceInstance</span> = &#123;</span><br><span class="line">    gatewayContext.getGatewayRoute.getRequestURI <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">EntranceGatewayRouter</span>.<span class="type">ENTRANCE_REGEX</span>(_) =&gt;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        serviceId.map(applicationName =&gt; &#123;</span><br><span class="line">          rules <span class="keyword">match</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> array: <span class="type">Array</span>[<span class="type">EntranceGatewayRouterRuler</span>] =&gt; array.foreach(_.rule(applicationName, gatewayContext))</span><br><span class="line">            <span class="keyword">case</span> _ =&gt;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="type">ServiceInstance</span>(applicationName, gatewayContext.getGatewayRoute.getServiceInstance.getInstance)</span><br><span class="line">        &#125;).orNull</span><br><span class="line">      <span class="keyword">case</span> _ =&gt; <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>linkis-gateway-ujes-datasource-ruler 模块，主要是做了一个 DataSource 和 Entrance Instance 的映射，并保存在 Mysql 中。DatasourceGatewayRouterRuler 实现了具体的路由策略，DatasourceMapService 接口维护 DataSource 映射。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 维护 DataSource 映射的接口</span></span><br><span class="line">public interface <span class="type">DatasourceMapService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> getInstanceByDatasource(<span class="type">String</span> datasourceName);</span><br><span class="line"></span><br><span class="line">    long countByInstance(<span class="type">String</span> instance);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> insertDatasourceMap(<span class="type">String</span> datasourceName, <span class="type">String</span> instance, <span class="type">String</span> serviceId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EntranceGatewayRouterRuler 的实现类，执行具体的路由逻辑</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatasourceGatewayRouterRuler</span> <span class="keyword">extends</span> <span class="title">EntranceGatewayRouterRuler</span> <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路由的方法</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">rule</span></span>(serviceId: <span class="type">String</span>, gatewayContext: <span class="type">GatewayContext</span>): <span class="type">Unit</span> = <span class="keyword">if</span>(<span class="type">StringUtils</span>.isNotBlank(gatewayContext.getRequest.getRequestBody)) &#123;</span><br><span class="line">    <span class="comment">// 从请求中获取 datasourceName</span></span><br><span class="line">    <span class="keyword">val</span> datasourceName = getDatasourceName(gatewayContext.getRequest.getRequestBody)</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">StringUtils</span>.isBlank(datasourceName)) <span class="keyword">return</span></span><br><span class="line">    debug(<span class="string">s&quot;datasourceName: <span class="subst">$datasourceName</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 通过 datasourceName 获取映射</span></span><br><span class="line">    datasourceMapService.getInstanceByDatasource(datasourceName) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> i: <span class="type">String</span> <span class="keyword">if</span> <span class="type">StringUtils</span>.isNotBlank(i) =&gt; </span><br><span class="line">        <span class="comment">// 存在映射直接返回 Instance</span></span><br><span class="line">        gatewayContext.getGatewayRoute.getServiceInstance.setInstance(i)</span><br><span class="line">      <span class="keyword">case</span> _ =&gt; &#123;</span><br><span class="line">        <span class="comment">// 不存在映射时，先获取 Instance 列表，并根据已经存在映射的数据按照从小到大排序，获取最少映射的 Instance，插入 DataSource 映射并返回</span></span><br><span class="line">        <span class="keyword">val</span> newInstance = <span class="type">ServiceInstanceUtils</span>.getRPCServerLoader.getServiceInstances(serviceId)</span><br><span class="line">          .map(item =&gt; (item, datasourceMapService.countByInstance(item.getInstance)))</span><br><span class="line">          .sortBy(_._2).map(_._1.getInstance).headOption <span class="keyword">match</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="type">Some</span>(item) =&gt; datasourceMapService.insertDatasourceMap(datasourceName, item, serviceId)</span><br><span class="line">            <span class="keyword">case</span> <span class="type">None</span> =&gt; <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        debug(<span class="string">s&quot;newInstance: <span class="subst">$newInstance</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">StringUtils</span>.isNotBlank(newInstance)) &#123;</span><br><span class="line">          gatewayContext.getGatewayRoute.getServiceInstance.setInstance(newInstance)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linkis/" rel="tag"># Linkis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/10/30/Linkis-%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5/" rel="next" title="Linkis 权限系统对接">
                <i class="fa fa-chevron-left"></i> Linkis 权限系统对接
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/14/Gremlin-Server-Console-%E9%80%82%E9%85%8D-Atlas-JanusGraph/" rel="prev" title="Gremlin Server/Console 适配 Atlas JanusGraph">
                Gremlin Server/Console 适配 Atlas JanusGraph <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

   
    <div id="gitalk-container"></div>
	
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wForget" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linkis-%E6%96%B0%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB"><span class="nav-number">1.</span> <span class="nav-text">Linkis 新引擎实现分享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">2.</span> <span class="nav-text">执行引擎架构的选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6"><span class="nav-number">3.</span> <span class="nav-text">引擎资源控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Entrance-EngineManger-Engine-%E6%A8%A1%E5%BC%8F%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6"><span class="nav-number">3.1.</span> <span class="nav-text">Entrance-EngineManger-Engine 模式资源控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Entrance-%E6%A8%A1%E5%BC%8F%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-number">3.2.</span> <span class="nav-text">Entrance 模式并发控制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-%E5%BC%95%E6%93%8E%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">ElasticSearch 引擎的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DataSource-%E8%B7%AF%E7%94%B1"><span class="nav-number">5.</span> <span class="nav-text">DataSource 路由</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#linkis-gateway-ujes-datasource-ruler-%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.1.</span> <span class="nav-text">linkis-gateway-ujes-datasource-ruler 模块的实现</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangz</span>

  
</div>









        







  <div style="display: none;">
    <script src="//s23.cnzz.com/z_stat.php?id=1276876819&web_id=1276876819" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'b865ed71dd6039d51290',
          clientSecret: '40e9912d3048a9f67b6470357f92ecd46dc52567',
          repo: 'wForget.github.io',
          owner: 'wForget',
          admin: ['wForget'],
		  id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  





  

  

  

  
  

  

  

  

</body>
</html>
