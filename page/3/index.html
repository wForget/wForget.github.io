<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="nPT3ONUGntVHfQCZH2D5GcUMgg5DH4IReN4GIs0GrW8" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="好记性不如烂笔头！">
<meta property="og:type" content="website">
<meta property="og:title" content="wForget&#39;s blog">
<meta property="og:url" content="https://wforget.github.io/page/3/index.html">
<meta property="og:site_name" content="wForget&#39;s blog">
<meta property="og:description" content="好记性不如烂笔头！">
<meta property="og:locale">
<meta property="article:author" content="wangz">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wforget.github.io/page/3/"/>





  <title>wForget's blog</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wForget's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/12/11/%E5%A3%B0%E6%98%8E%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%92%8C%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B%EF%BC%88%E8%BD%AC%E8%BD%BD%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/11/%E5%A3%B0%E6%98%8E%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%92%8C%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B%EF%BC%88%E8%BD%AC%E8%BD%BD%EF%BC%89/" itemprop="url">声明式编程和命令式编程（转载）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-11T11:14:03+08:00">
                2019-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="声明式编程和命令式编程（转载）"><a href="#声明式编程和命令式编程（转载）" class="headerlink" title="声明式编程和命令式编程（转载）"></a>声明式编程和命令式编程（转载）</h2><p>原文地址：<a target="_blank" rel="noopener" href="http://www.aqee.net/post/imperative-vs-declarative.html">声明式编程和命令式编程的比较</a></p>
<h3 id="先统一一下概念，我们有两种编程方式：命令式和声明式。"><a href="#先统一一下概念，我们有两种编程方式：命令式和声明式。" class="headerlink" title="先统一一下概念，我们有两种编程方式：命令式和声明式。"></a>先统一一下概念，我们有两种编程方式：命令式和声明式。</h3><p>我们可以像下面这样定义它们之间的不同：</p>
<ul>
<li>命令式编程：命令“机器”如何去做事情(how)，这样不管你想要的是什么(what)，它都会按照你的命令实现。</li>
<li>声明式编程：告诉“机器”你想要的是什么(what)，让机器想出如何去做(how)。</li>
</ul>
<img src="/2019/12/11/%E5%A3%B0%E6%98%8E%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%92%8C%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B%EF%BC%88%E8%BD%AC%E8%BD%BD%EF%BC%89/Imperative-vs-Declarative.png" class="" title="[Imperative-vs-Declarative]">

<h3 id="声明式编程和命令式编程的代码例子"><a href="#声明式编程和命令式编程的代码例子" class="headerlink" title="声明式编程和命令式编程的代码例子"></a>声明式编程和命令式编程的代码例子</h3><p>举个简单的例子，假设我们想让一个数组里的数值翻倍。</p>
<p>我们用命令式编程风格实现，像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var numbers = [1,2,3,4,5]</span><br><span class="line"></span><br><span class="line">var doubled = []</span><br><span class="line"></span><br><span class="line">for(var i = 0; i &lt; numbers.length; i++) &#123;</span><br><span class="line">  var newNumber = numbers[i] * 2</span><br><span class="line">  doubled.push(newNumber)</span><br><span class="line">&#125;</span><br><span class="line">console.log(doubled) //=&gt; [2,4,6,8,10]</span><br></pre></td></tr></table></figure>

<p>我们直接遍历整个数组，取出每个元素，乘以二，然后把翻倍后的值放入新数组，每次都要操作这个双倍数组，直到计算完所有元素。</p>
<p>而使用声明式编程方法，我们可以用 Array.map 函数，像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var numbers = [1,2,3,4,5]</span><br><span class="line"></span><br><span class="line">var doubled = numbers.map(function(n) &#123;</span><br><span class="line">  return n * 2</span><br><span class="line">&#125;)</span><br><span class="line">console.log(doubled) //=&gt; [2,4,6,8,10]</span><br></pre></td></tr></table></figure>

<p>map 利用当前的数组创建了一个新数组，新数组里的每个元素都是经过了传入map的函数(这里是function(n) { return n*2 })的处理。</p>
<p>map函数所作的事情是将直接遍历整个数组的过程归纳抽离出来，让我们专注于描述我们想要的是什么(what)。注意，我们传入map的是一个纯函数；它不具有任何副作用(不会改变外部状态)，它只是接收一个数字，返回乘以二后的值。</p>
<p>在一些具有函数式编程特征的语言里，对于list数据类型的操作，还有一些其他常用的声明式的函数方法。例如，求一个list里所有值的和，命令式编程会这样做：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var numbers = [1,2,3,4,5]</span><br><span class="line"></span><br><span class="line">var total = 0</span><br><span class="line"></span><br><span class="line">for(var i = 0; i &lt; numbers.length; i++) &#123;</span><br><span class="line">  total += numbers[i]</span><br><span class="line">&#125;</span><br><span class="line">console.log(total) //=&gt; 15</span><br></pre></td></tr></table></figure>

<p>而在声明式编程方式里，我们使用 reduce 函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var numbers = [1,2,3,4,5]</span><br><span class="line"></span><br><span class="line">var total = numbers.reduce(function(sum, n) &#123;</span><br><span class="line">  return sum + n</span><br><span class="line">&#125;);</span><br><span class="line">console.log(total) //=&gt; 15</span><br></pre></td></tr></table></figure>

<p>reduce 函数利用传入的函数把一个 list 运算成一个值。它以这个函数为参数，数组里的每个元素都要经过它的处理。每一次调用，第一个参数(这里是sum)都是这个函数处理前一个值时返回的结果，而第二个参数(n)就是当前元素。这样下来，每此处理的新元素都会合计到sum中，最终我们得到的是整个数组的和。</p>
<p>同样，reduce 函数归纳抽离了我们如何遍历数组和状态管理部分的实现，提供给我们一个通用的方式来把一个 list 合并成一个值。我们需要做的只是指明我们想要的是什么？</p>
<h3 id="声明式编程语言：SQL"><a href="#声明式编程语言：SQL" class="headerlink" title="声明式编程语言：SQL"></a>声明式编程语言：SQL</h3><p>也许你还不能明白，但有一个地方，你也许已经用到了声明式编程，那就是SQL。</p>
<p>你可以把SQL当做一个处理数据的声明式查询语言。完全用SQL写一个应用程序？这不可能。但如果是处理相互关联的数据集，它就显的无比强大了。</p>
<p>像下面这样的查询语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT * from dogs</span><br><span class="line">INNER JOIN owners</span><br><span class="line"></span><br><span class="line">WHERE dogs.owner_id = owners.id</span><br></pre></td></tr></table></figure>

<p>如果我们用命令式编程方式实现这段逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//dogs = [&#123;name: &#x27;Fido&#x27;, owner_id: 1&#125;, &#123;...&#125;, ... ]</span><br><span class="line">//owners = [&#123;id: 1, name: &#x27;Bob&#x27;&#125;, &#123;...&#125;, ...]</span><br><span class="line"></span><br><span class="line">var dogsWithOwners = []</span><br><span class="line">var dog, owner</span><br><span class="line"></span><br><span class="line">for(var di=0; di &lt; dogs.length; di++) &#123;</span><br><span class="line">  dog = dogs[di]</span><br><span class="line"></span><br><span class="line">  for(var oi=0; oi &lt; owners.length; oi++) &#123;</span><br><span class="line">    owner = owners[oi]</span><br><span class="line">    if (owner &amp;&amp; dog.owner_id == owner.id) &#123;</span><br><span class="line">      dogsWithOwners.push(&#123;</span><br><span class="line">        dog: dog,</span><br><span class="line">        owner: owner</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我可没说SQL是一种很容易懂的语言，也没说一眼就能把它们看明白，但基本上还是很整洁的。</p>
<p>SQL代码不仅很短，不不仅容易读懂，它还有更大的优势。因为我们归纳抽离了how，我们就可以专注于what，让数据库来帮我们优化how.</p>
<p>我们的命令式编程代码会运行的很慢，因为需要遍历所有 list 里的每个狗的主人。</p>
<p>而SQL例子里我们可以让数据库来处理how，来替我们去找我们想要的数据。如果需要用到索引(假设我们建了索引)，数据库知道如何使用索引，这样性能又有了大的提升。如果在此不久之前它执行过相同的查询，它也许会从缓存里立即找到。通过放手how，让机器来做这些有难度的事，我们不需要掌握数据库原理就能轻松的完成任务。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/11/19/%E3%80%8ASpark%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86%E3%80%8B-%E4%B8%80%E3%80%81Spark%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/19/%E3%80%8ASpark%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86%E3%80%8B-%E4%B8%80%E3%80%81Spark%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" itemprop="url">《Spark知识梳理》 一、Spark基本概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-19T13:40:07+08:00">
                2019-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>《Spark 知识梳理》系列文章主要是通过阅读《Spark内核设计的艺术》书籍，整理的一些个人笔记。</p>
<h2 id="Spark-特点"><a href="#Spark-特点" class="headerlink" title="Spark 特点"></a>Spark 特点</h2><blockquote>
<p>减少磁盘IO</p>
</blockquote>
<p>Spark 将 map 端中间结果存在内存中。</p>
<blockquote>
<p>增加并行度</p>
</blockquote>
<p>对 Job 划分成多个 Stage，有些 Stage 可以并行执行，增加并行度。</p>
<blockquote>
<p>避免重复计算</p>
</blockquote>
<p>任务失败重新调度时，会过滤掉执行成功的分区任务。</p>
<blockquote>
<p>可选的 Shuffle 排序</p>
</blockquote>
<p>Spark 可根据不同场景选择在 map 端或是 reduce 端进行 Shuffle 排序</p>
<blockquote>
<p>灵活的内存管理</p>
</blockquote>
<p>Spark 将内存分为，堆上存储内存、堆外存储内存、堆上执行内存和堆外执行内存，并且提供了存储内存和执行内存之间动态占用空闲区域。</p>
<blockquote>
<p>检查点 </p>
</blockquote>
<p>启用检查点会保存 RDD 计算的结果，失败重建时不需要重新计算 RDD。</p>
<h2 id="Spark-基础知识"><a href="#Spark-基础知识" class="headerlink" title="Spark 基础知识"></a>Spark 基础知识</h2><blockquote>
<p>RDD</p>
</blockquote>
<p>RDD（Resilient Distributed Dataset），弹性分布式数据集。</p>
<blockquote>
<p>DAG</p>
</blockquote>
<p>DAG（Directed Acycle Graph），有向无环图。反应 RDD 之间的依赖。</p>
<blockquote>
<p>Partition</p>
</blockquote>
<p>一个 RDD 可以划分成多个 Partition，Spark 根据 Partition 的数量确定 Task 的数量。</p>
<blockquote>
<p>NarrowDependency</p>
</blockquote>
<p>NarrowDependency（窄依赖），子 RDD 依赖于父 RDD 固定的 Partition。分为 OneToOneDependency 和 RangeDependency。</p>
<blockquote>
<p>ShuffleDependency</p>
</blockquote>
<p>ShuffleDependency（宽依赖），子 RDD 对父 RDD 中所有的 Partition 都有可能产生依赖，具体依赖取决于分区计算器（Partitioner）的算法。</p>
<blockquote>
<p>Job</p>
</blockquote>
<p>用户提交的作业。</p>
<blockquote>
<p>Stage</p>
</blockquote>
<p>Job 执行阶段。DAGScheduler 按照 ShuffleDependency 作为 Stage 划分节点对 RDD 的 DAG 进行 Stage 划分（上游 Stage 作为 ShuffleMapStage）。Stage 分为 ShuffleMapStage 和 ResultStage。</p>
<blockquote>
<p>Task</p>
</blockquote>
<p>具体执行的任务。一个 Job 在每个 Stage 都会按照 RDD 的 Partition 数量创建 Task。Task 分为 ShuffleMapTask（类似 map） 和 ResultTask（类似  reduce）。</p>
<blockquote>
<p>Shuffle</p>
</blockquote>
<p>Shuffle 是 map 任务输出到 reduce 任务输入的中间处理过程。将 map 任务的输出按照指定的分区策略（如，按 key 的 hash 值）分配给某个分区的 reduce 任务。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/04/12/Nginx%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/Nginx%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/" itemprop="url">Nginx配置指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:21:39+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Nginx配置指南"><a href="#Nginx配置指南" class="headerlink" title="Nginx配置指南"></a>Nginx配置指南</h2><h3 id="nginx-conf-文件结构"><a href="#nginx-conf-文件结构" class="headerlink" title="nginx.conf 文件结构"></a>nginx.conf 文件结构</h3><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/knowledgesea/p/5175711.html">Nginx配置详解</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...              #全局块</span><br><span class="line"></span><br><span class="line">events &#123;         #events块</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http      #http块</span><br><span class="line">&#123;</span><br><span class="line">    ...   #http全局块</span><br><span class="line">    server        #server块</span><br><span class="line">    &#123; </span><br><span class="line">        ...       #server全局块</span><br><span class="line">        location [PATTERN]   #location块</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        location [PATTERN] </span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server</span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...     #http全局块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</li>
<li>events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li>
<li>http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li>
<li>server块：配置虚拟主机的相关参数，一个http中可以有多个server。</li>
<li>location块：配置请求的路由，以及各种页面的处理情况。</li>
</ol>
<h3 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h3><blockquote>
<p>全局块</p>
</blockquote>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>user</td>
<td>配置 worker 进程的用户和组</td>
</tr>
<tr>
<td>worker_processes</td>
<td>指定 worker 进程启动数量，用于处理客户端的所有连接。设置该值为 CPU 的核数。(max_clients &#x3D; worker_processes * worker_connections)</td>
</tr>
<tr>
<td>error_log</td>
<td>指定日志文件，如果在其他区段中没有设置其他的 error_log ，那么这个日志文件将会记录所有的错误。该指令的第二个参数指定了被记录错误的级别(debug 、info 、notice 、warn 、error 、crit 、alert 、emerg )。注意 debug 级别的错误只有在编译时配置了 –with-debug 选项才可以使用。</td>
</tr>
<tr>
<td>pid</td>
<td>设置记录主进程 ID 的文件</td>
</tr>
</tbody></table>
<blockquote>
<p>events块</p>
</blockquote>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>use</td>
<td>选择事件模型，默认 Nginx 会自动使用最适合的事件模型。对于Linux操作系统来说，可供选择的事件驱动模型有poll、select、epoll三种。epoll 是性能最高的一种。</td>
</tr>
<tr>
<td>worker_connections</td>
<td>定义每个worker进程可以同时处理的最大连接数</td>
</tr>
</tbody></table>
<blockquote>
<p>http块</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/04/11/Nginx%E6%89%93%E5%8D%B0RequestBody/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/11/Nginx%E6%89%93%E5%8D%B0RequestBody/" itemprop="url">Nginx打印RequestBody</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-11T15:48:39+08:00">
                2019-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Nginx打印RequestBody"><a href="#Nginx打印RequestBody" class="headerlink" title="Nginx打印RequestBody"></a>Nginx打印RequestBody</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>新的日志收集构架中直接去掉 SpringBoot 服务，而是通过 Nginx 作为服务器，收集日志，打印成日志文件，通过 Flume 消费到 Kafka 中。由于日志收集的请求都是 Post JSON 的格式，所以需要在 Nginx 中获取 Post 的 Body。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>在配置 log_format 后，发现无法打印 $request_body</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_format user_log_format escape=json &#x27;&#123;&quot;time&quot;: &quot;$msec&quot;, &quot;ip&quot;: &quot;$remote_addr&quot;, &quot;ua&quot;: &quot;$http_user_agent&quot;, &quot;data&quot;: &quot;$request_body&quot;&#125;&#x27;;</span><br></pre></td></tr></table></figure>
<p>查看官方文档，有如下注释。意思是说 $request_body 需要在带有 proxy_pass, fastcgi_pass, uwsgi_pass, scgi_pass 这些指令的 location 中，当 request_body 被读到内存缓冲区中使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The variable’s value is made available in locations processed by the proxy_pass, fastcgi_pass, uwsgi_pass, and scgi_pass directives when the request body was read to a memory buffer.</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-安装"><a href="#Nginx-安装" class="headerlink" title="Nginx 安装"></a>Nginx 安装</h3><p>由于在解决问题的时候需要使用到 ngx_lua 模块，所以我是直接安装的 OpenResty。<br>官网：<a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a><br>安装文档：<a target="_blank" rel="noopener" href="http://openresty.org/cn/installation.html">http://openresty.org/cn/installation.html</a></p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><blockquote>
<p>在使用 （proxy_pass, fastcgi_pass, uwsgi_pass, scgi_pass） 指令的 location 中打印日志。</p>
</blockquote>
<blockquote>
<p>使用 HTTP Echo Module (OpenResty 中已经包括了这个模块)。</p>
</blockquote>
<p>HTTP Echo Module 参考文档：<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/echo/">https://www.nginx.com/resources/wiki/modules/echo/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">error_log logs/error.log;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       /usr/local/openresty/nginx/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 日志文件格式  access.log  nginx默认的日志文件</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent $host &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    # 日志文件格式 user_defined.log  数据会写到这个文件中</span><br><span class="line">    log_format user_log_format escape=json &#x27;&#123;&quot;time&quot;: &quot;$msec&quot;, &quot;ip&quot;: &quot;$remote_addr&quot;, &quot;ua&quot;: &quot;$http_user_agent&quot;, &quot;data&quot;: &quot;$request_body&quot;&#125;&#x27;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        set $p_body &quot;&quot;;</span><br><span class="line">        location / &#123;</span><br><span class="line">            access_log /data/nginx/logs/user_defined.log user_log_format;</span><br><span class="line">            echo_read_request_body;</span><br><span class="line">            echo &#x27;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 ngx_lua 模块</p>
</blockquote>
<p>Lua 参考文档：<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/lua/">https://www.nginx.com/resources/wiki/modules/lua/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">error_log logs/error.log;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       /usr/local/openresty/nginx/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 日志文件格式  access.log  nginx默认的日志文件</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent $host &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    # 日志文件格式 user_defined.log  数据会写到这个文件中</span><br><span class="line">    log_format user_log_format escape=json &#x27;&#123;&quot;time&quot;: &quot;$msec&quot;, &quot;ip&quot;: &quot;$remote_addr&quot;, &quot;ua&quot;: &quot;$http_user_agent&quot;, &quot;data&quot;: &quot;$request_body&quot;&#125;&#x27;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        set $p_body &quot;&quot;;</span><br><span class="line">        location / &#123;</span><br><span class="line">            lua_need_request_body on;                                                                                            </span><br><span class="line">            content_by_lua &#x27;local s = ngx.req.get_body_data()&#x27;;</span><br><span class="line">            </span><br><span class="line">            access_log /data/nginx/logs/user_defined.log user_log_format;</span><br><span class="line">            # echo &#x27;&#x27;;	# 注意这个不能使用 echo 命令和 return 命令</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以通过自定义的变量存放 request_body，然后再 log_format 中使用自定义变量打印。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">error_log logs/error.log;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       /usr/local/openresty/nginx/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 日志文件格式  access.log  nginx默认的日志文件</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent $host &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    # 日志文件格式 user_defined.log  数据会写到这个文件中</span><br><span class="line">    log_format user_log_format escape=json &#x27;&#123;&quot;time&quot;: &quot;$msec&quot;, &quot;ip&quot;: &quot;$remote_addr&quot;, &quot;ua&quot;: &quot;$http_user_agent&quot;, &quot;data&quot;: &quot;$p_body&quot;&#125;&#x27;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        set $p_body &quot;&quot;;</span><br><span class="line">        location / &#123;</span><br><span class="line">            lua_need_request_body on;</span><br><span class="line">            content_by_lua &#x27;</span><br><span class="line">                local p_body = ngx.req.get_body_data() or &quot;&quot;</span><br><span class="line">                ngx.var.p_body = p_body</span><br><span class="line">            &#x27;;</span><br><span class="line">			access_log /data/nginx/logs/user_defined.log user_log_format;</span><br><span class="line">            # echo &#x27;&#x27;;	# 注意这个不能使用 echo 命令和 return 命令</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/03/28/Redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/Redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" itemprop="url">Redis 分布式锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-28T11:11:09+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Redis-分布式锁"><a href="#Redis-分布式锁" class="headerlink" title="Redis 分布式锁"></a>Redis 分布式锁</h2><p>分布式锁就是在分布式环境下获取锁，实现进程以独占资源的方式访问共享资源。</p>
<h3 id="Redis-分布式锁的特性"><a href="#Redis-分布式锁的特性" class="headerlink" title="Redis 分布式锁的特性"></a>Redis 分布式锁的特性</h3><ul>
<li>独享。同一时刻，只能有一个客户端获取到锁。</li>
<li>无死锁。即使持有锁的客户端奔溃或网络断开，锁仍然可以被获取。</li>
<li>容错。只要大部分Redis节点都活着，客户端就可以获取和释放锁。</li>
</ul>
<h3 id="单-Redis-实例实现分布式锁实现"><a href="#单-Redis-实例实现分布式锁实现" class="headerlink" title="单 Redis 实例实现分布式锁实现"></a>单 Redis 实例实现分布式锁实现</h3><blockquote>
<p>SET 命令</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SET key value [EX seconds] [PX milliseconds] [NX|XX]</span><br><span class="line"># EX seconds – 设置键key的过期时间，单位时秒</span><br><span class="line"># PX milliseconds – 设置键key的过期时间，单位时毫秒</span><br><span class="line"># NX – 只有键key不存在的时候才会设置key的值</span><br><span class="line"># XX – 只有键key存在的时候才会设置key的值</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取锁</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取 分布式锁</span><br><span class="line"> * @param lockName  锁的 key</span><br><span class="line"> * @return 成功时返回一个随机生成的id，为了正确的释放锁，失败时返回 null</span><br><span class="line"> */</span><br><span class="line">public static String getLock(String lockName) &#123;</span><br><span class="line">	String result = null;</span><br><span class="line">	try (Jedis jedis = getJedis()) &#123;</span><br><span class="line">		String randomId = UUID.randomUUID().toString();</span><br><span class="line">		// EX seconds – 设置键key的过期时间，单位时秒。PX milliseconds – 设置键key的过期时间，单位时毫秒。NX – 只有键key不存在的时候才会设置key的值。XX – 只有键key存在的时候才会设置key的值</span><br><span class="line">		String status =  jedis.set(lockName, randomId, &quot;nx&quot;, &quot;px&quot;, 10000);    // 10s 过期时间</span><br><span class="line">		if (&quot;OK&quot;.equals(status)) &#123;</span><br><span class="line">			result = randomId;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">		String msg = ExceptionUtil.stackTraceMsg(e);</span><br><span class="line">		logger.error(msg);</span><br><span class="line">	&#125;</span><br><span class="line">	return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>释放锁</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 释放锁</span><br><span class="line"> * @param lockName 锁的名称</span><br><span class="line"> * @param randomId 获取锁时返回的的id</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public static boolean releaseLock(String lockName, String randomId) &#123;</span><br><span class="line">    boolean result = false;</span><br><span class="line">    // Lua 脚本</span><br><span class="line">    String script = &quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1] then\n&quot; +</span><br><span class="line">                    &quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot; +</span><br><span class="line">                    &quot;else\n&quot; +</span><br><span class="line">                    &quot;    return 0\n&quot; +</span><br><span class="line">                    &quot;end&quot;;</span><br><span class="line">    try (Jedis jedis = getJedis()) &#123;</span><br><span class="line">        Long status = (Long) jedis.eval(script, Collections.singletonList(lockName), Collections.singletonList(randomId));</span><br><span class="line">        if (status.longValue() == 1L) &#123;</span><br><span class="line">            result = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        String msg = ExceptionUtil.stackTraceMsg(e);</span><br><span class="line">        logger.error(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>单 Redis 实例实现分布式锁存在的问题</p>
</blockquote>
<p>在单 Redis 实例的分布式锁实现中存在的最严重的问题就是单节点失败的问题，不能保证 Redis 永远不会挂掉。<br>在主从结构的 Redis 集群中，这种构架也是有问题的，不能实现资源的独享，因为 Redis 的主从同步通常是异步的：</p>
<ol>
<li>客户端 A 从 Master 获取到锁</li>
<li>在 Master 同步到 Slave 之前，Master 节点挂掉了</li>
<li>Slave 节点成为了 Master 节点</li>
<li>客户端B取得了同一个资源被客户端A已经获取到的另外一个锁。安全失效！</li>
</ol>
<p>Redis 宕机毕竟是小概率实现，所以在可以忽略宕机的事件时，这个构架还是很实用的。</p>
<h3 id="Redlock"><a href="#Redlock" class="headerlink" title="Redlock"></a>Redlock</h3><p>Redlock 是 Antirez 提出的，使用多个完全独立的 Redis 实例，来实现分布式锁的算法。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://redis.io/topics/distlock#the-redlock-algorithm">The Redlock algorithm</a><br>参考：<a target="_blank" rel="noopener" href="https://my.oschina.net/yanpenglei/blog/2874699">Redis集群下的RedLock算法(真分布式锁) 实践</a></p>
<h3 id="Redisson-分布式锁"><a href="#Redisson-分布式锁" class="headerlink" title="Redisson 分布式锁"></a>Redisson 分布式锁</h3><p>参考：<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8">分布式锁和同步器</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/02/22/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%B8%89%E3%80%81%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/22/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%B8%89%E3%80%81%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95/" itemprop="url">《Phoenix使用总结》 三、二级索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-22T17:51:40+08:00">
                2019-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="二级索引"><a href="#二级索引" class="headerlink" title="二级索引"></a>二级索引</h2><h3 id="HBase-二级索引方案"><a href="#HBase-二级索引方案" class="headerlink" title="HBase 二级索引方案"></a>HBase 二级索引方案</h3><p>HBase 中的行是以 RowKey 的字典序排序存储。所以对于 HBase 的快速查询主要有两种场景，一种是根据 RowKey 快速查询单行数据，另一种是基于 RowKey 的前缀查询。由于 HBase 只有 RowKey 的一级索引，根据其他的字段进行查询效率是很低的，实际业务场景中可能需要引入二级索引。</p>
<p>我所了解的 HBase 二级索引的解决思路有如下几种：</p>
<ul>
<li>官方的解决方案是使用 Coprocessor(类似触发器)，自定义写入逻辑，当有数据写入时同时写入一份索引表。</li>
<li>可以使用其他的工具在外部构建和维护索引关系，索引字段和 RowKey 的对应关系，比如使用 Elasticsearch、MongoDB 等。</li>
<li>使用 Phoenix 构建二级索引。</li>
</ul>
<p>Coprocessor 的方案由于运行都交给了 Regionserver，侵入性比较强，会对 Regionserver 的性能造成影响。第一版的时候我使用了 MongoDB 维护了索引关系，后期数据量达到 20 亿，对 MongoDB 所在的服务器造成了很大的压力，所以后期决定使用基于 HBase 的 Phoenix 构建二级索引。</p>
<h3 id="Phoenix-二级索引"><a href="#Phoenix-二级索引" class="headerlink" title="Phoenix 二级索引"></a>Phoenix 二级索引</h3><p>官方文档：<a target="_blank" rel="noopener" href="http://phoenix.apache.org/secondary_indexing.html">http://phoenix.apache.org/secondary_indexing.html</a></p>
<h4 id="索引特性"><a href="#索引特性" class="headerlink" title="索引特性"></a>索引特性</h4><blockquote>
<p>Covered Indexes(覆盖索引) </p>
</blockquote>
<p>覆盖索引指的是把查询相关的字段都指定在索引中，这样查询就只需要在索引表中查询就行。建立索引的语句如下，把查询的字段（where条件字段）放在 ON 语句中，把其他需要查询出来的字段（其他 select 字段）放在 INCLUDE 中。</p>
<p>Phoenix 的索引其实就是维护一张 HBase 表（本地索引与原始数据同一张表），把索引的字段作为 RowKey，把 INCLUDE 的字段放在 COLUMN 中。所以索引的顺序也注意，需要把条件中一定有的字段放在前面，可能有的字段放在后面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX my_index ON my_table (v1,v2) INCLUDE(v3);</span><br><span class="line">SELECT v1, v2, v3 FROM my_table WHERE v1=&#x27;&#x27; AND v2=&#x27;&#x27;;	// where 条件中 v1、v2 字段放在 ON 语句中，其他查询字段 v3 放在 INCLUDE 语句中</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Functional Indexes(函数索引)</p>
</blockquote>
<p>索引的字段不局限与列，支持任意的表达式来创建索引。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX UPPER_NAME_IDX ON EMP (UPPER(FIRST_NAME||&#x27; &#x27;||LAST_NAME));</span><br><span class="line">SELECT EMP_ID FROM EMP WHERE UPPER(FIRST_NAME||&#x27; &#x27;||LAST_NAME)=&#x27;JOHN DOE&#x27;;	// 使用函数索引，生成大写的 FIRST_NAME + LAST_NAME 的索引</span><br></pre></td></tr></table></figure>

<h4 id="构建索引"><a href="#构建索引" class="headerlink" title="构建索引"></a>构建索引</h4><p>Phoenix 支持两种类型的索引机制，Global Indexes(全局索引) 和 Local Indexes(本地索引)，不同的索引机制适用于不同的业务场景，默认是构建全局索引。全局索引是维护了一张新的索引表，本地索引的索引数据存在了原始数据表中(4.8.0之后)。</p>
<blockquote>
<p>Global Indexes(全局索引)</p>
</blockquote>
<p>Global Indexes(全局索引) 适用于大量读取操作的场景。所有数据的更新和写操作都需要更新相关的索引表，所以开销主要发生在写入阶段，查询是直接查询索引表，所以查询开销较小。由于只会查询索引表，所以在建立索引时需要合理设计 INCLUDE 字段，把需要查询的字段都放进去。</p>
<blockquote>
<p>Local Indexes(本地索引)</p>
</blockquote>
<p>Local Indexes(本地索引) 适用于大量写入操作的场景。本地索引的索引数据放在了数据表中(从4.8.0开始，我们将所有本地索引数据存储在同一数据表中的单独阴影列族中)，索引数据和原始数据是在同一台机器上面，所以没有额外的网络开销。本地索引可以使用在没有全面覆盖 INCLUDE 的场景。</p>
<h4 id="索引实例"><a href="#索引实例" class="headerlink" title="索引实例"></a>索引实例</h4><blockquote>
<p>异步创建索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 先创建异步索引</span><br><span class="line">CREATE INDEX async_index ON my_schema.my_table (v) ASYNC</span><br><span class="line"></span><br><span class="line"># 再通过 MapReduce 任务异步构建索引，output-path 是一个hdfs路径（存放 MapReduce 任务执行的临时文件）</span><br><span class="line">$&#123;HBASE_HOME&#125;/bin/hbase org.apache.phoenix.mapreduce.index.IndexTool</span><br><span class="line">  --schema my_schema --data-table my_table --index-table async_index</span><br><span class="line">  --output-path ASYNC_IDX_HFILES</span><br><span class="line"></span><br><span class="line"># 实例</span><br><span class="line">CREATE LOCAL INDEX match_index_new_qm ON PUBG.MATCH_INDEX_NEW(lowerNickName, type, mode, queueSize, startedAt DESC) INCLUDE (matchId, totalRank) ASYNC</span><br><span class="line"># 构建时发现无法找到 org.apache.phoenix.mapreduce.index.IndexTool 类，索引把 jar 加到 HBASE_CLASSPATH 中</span><br><span class="line">export HBASE_CLASSPATH=/opt/cloudera/parcels/APACHE_PHOENIX/lib/phoenix/phoenix-4.14.0-cdh5.13.2-client.jar</span><br><span class="line">hbase org.apache.phoenix.mapreduce.index.IndexTool --schema PUBG --data-table MATCH_INDEX_NEW --index-table match_index_new_qm --output-path /user/hadoop/wangzhen</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX my_index ON my_table (v1) INCLUDE (v2);</span><br><span class="line"></span><br><span class="line">CREATE INDEX my_index ON my_table (v2 DESC, v1) INCLUDE (v3)</span><br><span class="line">    SALT_BUCKETS=10, DATA_BLOCK_ENCODING=&#x27;NONE&#x27;;</span><br></pre></td></tr></table></figure>

<p>与CREATE TABLE语句一样，CREATE INDEX语句可以传递属性以应用于基础HBase表，包括对其进行加盐的能力，如果主表被加盐，则索引将以相同的方式自动为全局索引加盐。使用本地索引时，不允许指定SALT_BUCKETS。</p>
<blockquote>
<p>创建本地索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE LOCAL INDEX my_index ON my_table (v1)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询时指定索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT /*+ INDEX(my_table my_index) */ v2 FROM my_table WHERE v1 = &#x27;foo&#x27;</span><br></pre></td></tr></table></figure>



          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/02/22/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%BA%8C%E3%80%81Spark%E6%93%8D%E4%BD%9CPhoenix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/22/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%BA%8C%E3%80%81Spark%E6%93%8D%E4%BD%9CPhoenix/" itemprop="url">《Phoenix使用总结》 二、Spark操作Phoenix</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-22T17:06:30+08:00">
                2019-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Spark-操作-Phoenix"><a href="#Spark-操作-Phoenix" class="headerlink" title="Spark 操作 Phoenix"></a>Spark 操作 Phoenix</h2><p>由于之前的映射数据是存在 MongoDB 中，所以需要将 MongoDB 中的数据导入到 Phoenix 中。这里记录 Spark 对 Phoenix  的操作。</p>
<blockquote>
<p>Maven 依赖</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.phoenix&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;phoenix-spark&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;$&#123;phoenix.version&#125;&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从 Phoenix 读取数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val rdd: RDD[Map[String, AnyRef]] = sparkContext.phoenixTableAsRDD(</span><br><span class="line">  &quot;TABLE1&quot;, Seq(&quot;ID&quot;, &quot;COL1&quot;), zkUrl = Some(&quot;phoenix-server:2181&quot;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写入 Phoenix</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var matchIndexRDD = MongoSpark.load(sparkContext, ReadConfig(Map(&quot;uri&quot; -&gt; uri</span><br><span class="line">  , &quot;database&quot; -&gt; &quot;pubg&quot;</span><br><span class="line">  , &quot;collection&quot; -&gt; &quot;match_index&quot;)))</span><br><span class="line">  .filter(m =&gt; (StringUtils.isNotBlank(m.getString(&quot;lowerNickName&quot;)) &amp;&amp; m.getDate(&quot;startedAt&quot;) != null))</span><br><span class="line">  .map(m =&gt; (m.getString(&quot;lowerNickName&quot;), m.getDate(&quot;startedAt&quot;), m.getString(&quot;matchId&quot;)</span><br><span class="line">	, m.getString(&quot;mode&quot;), m.getInteger(&quot;queueSize&quot;), m.getInteger(&quot;totalRank&quot;), m.getString(&quot;type&quot;)))</span><br><span class="line">	</span><br><span class="line">matchIndexRDD.saveToPhoenix(</span><br><span class="line">  &quot;PUBG.MATCH_INDEX&quot;,</span><br><span class="line">  Seq(&quot;LOWERNICKNAME&quot;, &quot;STARTEDAT&quot;, &quot;MATCHID&quot;, &quot;MODE&quot;, &quot;QUEUESIZE&quot;, &quot;TOTALRANK&quot;, &quot;TYPE&quot;),</span><br><span class="line">  zkUrl = Some(&quot;datanode03:2181&quot;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2019/02/21/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%B8%80%E3%80%81%E4%BD%BF%E7%94%A8%E8%83%8C%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/%E3%80%8APhoenix%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E3%80%8B-%E4%B8%80%E3%80%81%E4%BD%BF%E7%94%A8%E8%83%8C%E6%99%AF/" itemprop="url">《Phoenix使用总结》 一、使用背景</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-21T16:39:18+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用背景"><a href="#使用背景" class="headerlink" title="使用背景"></a>使用背景</h2><p>项目中有一个 HBase 表需要根据特定的条件进行查询，并且无法通过一次 rowkey 的设计达到很好的效果。第一版，在 MongoDB 中对 HBase 表的数据建立一张映射表，通过查询条件在 MongoDB 中查询出 RowKey，再到 HBase 中通过 RowKey 进行查询。<br>到后期由于数据量的增大（20亿），MongoDB所在的机器负载太高。后面通过讨论，使用 Phoenix 做二级索引进行查询。</p>
<h2 id="Phoenix-简介"><a href="#Phoenix-简介" class="headerlink" title="Phoenix 简介"></a>Phoenix 简介</h2><p>Phoenix 是开源的构建于 HBase 之上的 SQL 层，使我们能够使用标准的 JDBC API 代替 HBase Client API 操作 Hbase 进行创建表、插入数据和查询数据。</p>
<p>Apache Phoenix 结合以下两点实现在 Hadoop 中低延迟的 OLTP 和 operational analytics：</p>
<ul>
<li>强大的标准SQL和完整 ACID 事务的 JDBC APIs</li>
<li>通过利用 HBase 作为后台存储，提供了NoSQL的late-bound, schema-on-read灵活的功能。</li>
</ul>
<p>官网：<a target="_blank" rel="noopener" href="http://phoenix.apache.org/">http://phoenix.apache.org/</a></p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><blockquote>
<p>Maven依赖</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.phoenix&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;phoenix-core&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;4.14.0-cdh5.13.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>JDBC 连接</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(&quot;org.apache.phoenix.jdbc.PhoenixDriver&quot;);</span><br><span class="line">Connection connection = DriverManager.getConnection(&quot;jdbc:phoenix:dmp-test01,dmp-test02,dmp-test03:2181&quot;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>DBCP 连接</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BasicDataSource xdataSource = new BasicDataSource();</span><br><span class="line">dataSource.setDriverClassName(&quot;org.apache.phoenix.jdbc.PhoenixDriver&quot;);</span><br><span class="line">dataSource.setUrl(&quot;jdbc:phoenix:datanode03,datanode04,datanode05:2181&quot;);</span><br><span class="line">Connection connection = dataSource.getConnection();</span><br></pre></td></tr></table></figure>

<p>可以参考我写的工具类：<a target="_blank" rel="noopener" href="https://github.com/wForget/ClientUtil/blob/master/src/main/java/cn/wangz/clientutil/phoenix/PhoenixDbcpUtils.java">PhoenixDbcpUtils.java</a></p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Phoenix 的语法：<a target="_blank" rel="noopener" href="http://phoenix.apache.org/language/index.html">http://phoenix.apache.org/language/index.html</a></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><blockquote>
<p>建表</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS PUBG.MATCH_INDEX (</span><br><span class="line">lowerNickName VARCHAR NOT NULL,</span><br><span class="line">startedAt DATE NOT NULL,</span><br><span class="line">matchId VARCHAR,</span><br><span class="line">mode VARCHAR,</span><br><span class="line">queueSize INTEGER,</span><br><span class="line">totalRank INTEGER,</span><br><span class="line">type VARCHAR,</span><br><span class="line">CONSTRAINT match_index_pk PRIMARY KEY (lowerNickName, startedAt))</span><br><span class="line">SALT_BUCKETS = 100;</span><br></pre></td></tr></table></figure>

<p>HBase 中有一个预分区的概念，防止热数据。Phoenix 建表时预分区的方案有两种，一种是使用 SPLIT ON 语句(与 HBase 的 SPLITS 概念一样)，另一种是 Salted Tables ，建表时指定 SALT_BUCKETS 数量，具体可参考：<a target="_blank" rel="noopener" href="http://phoenix.apache.org/salted.html">http://phoenix.apache.org/salted.html</a>。</p>
<blockquote>
<p>建立本地索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE LOCAL INDEX match_index_qm ON PUBG.MATCH_INDEX(lowerNickName, type, mode, queueSize, startedAt DESC) INCLUDE (matchId, totalRank) </span><br></pre></td></tr></table></figure>

<blockquote>
<p>插入数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPSERT INTO PUBG.MATCH_INDEX(LOWERNICKNAME, STARTEDAT, MATCHID, MODE, QUEUESIZE, TOTALRANK, TYPE) VALUES (?, ?, ?, ?, ? ,?, ?)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2018/11/27/Spring%E6%B3%A8%E8%A7%A3%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/Spring%E6%B3%A8%E8%A7%A3%E6%80%BB%E7%BB%93/" itemprop="url">Spring注解总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-27T17:19:28+08:00">
                2018-11-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Spring注解总结"><a href="#Spring注解总结" class="headerlink" title="Spring注解总结"></a>Spring注解总结</h2><h3 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h3><p>@Autowired 注解，自动装配，默认按类型匹配的方式，在容器查找匹配的 Bean，当有且仅有一个匹配的 Bean 时，Spring 将其注入 @Autowired 标注的变量中。<br>@Autowired 注解有一个 required 属性，默认为 true，当没有找到相应的 Bean 对象时会抛出异常，如果不想抛出异常可以将 required 设置为 false。</p>
<h3 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h3><p>如果容器中有一个以上匹配的 Bean，则可以通过 @Qualifier 注解限定Bean的名称，与 @Autowired 配合使用。value 属性指定 Bean 的名称。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">@Qualifier(value=&quot;beanName&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="Resource"><a href="#Resource" class="headerlink" title="@Resource"></a>@Resource</h3><p>@Resource 注解与 @Autowired 注解作用非常相似。</p>
<p>@Resource的装配顺序：</p>
<ol>
<li>@Resource 后面没有任何内容，默认通过 Name 属性去匹配 Bean，找不到再按 Type去匹配</li>
<li>指定了 Name 或者 Type 则根据指定的 Name 或者 Type 去匹配 Bean</li>
<li>指定了 Name 和 Type 则根据指定的 Name 和 Type 去匹配 Bean，任何一个不匹配都将报错</li>
</ol>
<p>@Autowired和@Resource两个注解的区别：</p>
<ol>
<li>@Autowired 默认按照 byType 方式进行 Bean 匹配，@Resource 默认按照 byName 方式进行 Bean 匹配</li>
<li>@Autowired 是 Spring 的注解，@Resource 是 J2EE 的注解</li>
</ol>
<h3 id="Component-x2F-Repository-x2F-Service-x2F-Controller"><a href="#Component-x2F-Repository-x2F-Service-x2F-Controller" class="headerlink" title="@Component&#x2F;@Repository&#x2F;@Service&#x2F;@Controller"></a>@Component&#x2F;@Repository&#x2F;@Service&#x2F;@Controller</h3><p>@Component&#x2F;@Repository&#x2F;@Service&#x2F;@Controller 可以向 Spring 容器注册 Bean。<br>需要在 applicationContext.xml 中注册 &lt;context:component-scan base-package&#x3D;”pagkage1[,pagkage2,…,pagkageN]”&#x2F;&gt;，或者使用 @ComponentScan 注解指定扫描包。</p>
<blockquote>
<p>@Component</p>
</blockquote>
<p>@Component 是所有受 Spring 管理的组件的通用形式，@Component 注解可以放在类的头上，@Component 不推荐使用。</p>
<blockquote>
<p>@Repository</p>
</blockquote>
<p>@Repository 对应数据访问层（Dao 层） Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository(value=&quot;userDao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">extends</span> <span class="title class_">BaseDaoImpl</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>@Service</p>
</blockquote>
<p>@Service 对应的是业务层（Service 层） Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;userService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>@Controller</p>
</blockquote>
<p>@Controller 对应表现层（Action 层） Bean。<br>value 属性用来指定 Bean 的名称，默认的名字为这个类的类名首字母小写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的还使用了 @Scope 注解，@Scope(“prototype”) 表示将 Controller 的范围声明为原型，保证每一个请求都 new 一个 Controller 对象来处理。<br>Spring 默认 scope 是单例模式(scope&#x3D;”singleton”)，表示只会创建一个对象，每次访问都是同一对象。</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><p>@Configuration 用于定义配置类，可替换 xml 配置文件，被注解的类内部包含有一个或多个被 @Bean 注解的方法，这些方法将会被 AnnotationConfigApplicationContext 或 AnnotationConfigWebApplicationContext 类进行扫描，并用于构建 Bean 定义，初始化 Spring 容器。</p>
<h3 id="ConfigurationProperties-x2F-EnableConfigurationProperties"><a href="#ConfigurationProperties-x2F-EnableConfigurationProperties" class="headerlink" title="@ConfigurationProperties&#x2F;@EnableConfigurationProperties"></a>@ConfigurationProperties&#x2F;@EnableConfigurationProperties</h3><p>@ConfigurationProperties 注解主要用来把 Properties 配置文件转化为 Bean 来使用的，而 @EnableConfigurationProperties 注解的作用是 @ConfigurationProperties 注解生效。<br>如果只配置 @ConfigurationProperties 注解，在 IOC 容器中是获取不到 Properties 配置文件转化的 Bean 的。<br>@ConfigurationProperties 注解可以把 Properties 文件转化为 Bean，然后使用 @Component 注解把该 Bean 注入到 IOC 容器中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">/*prefix定义配置文件中属性*/</span><br><span class="line">@ConfigurationProperties(prefix=&quot;local&quot;)</span><br><span class="line">public class ComponentProperties &#123;</span><br><span class="line">	// TODO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Configuration 把一个类作为一个IoC容器，它的某个方法头上如果注册了@Bean，就会作为这个Spring容器中的Bean。</span><br><span class="line">@Lazy(true) 表示延迟初始化</span><br><span class="line">@Service 用于标注业务层组件、 </span><br><span class="line">@Controller 用于标注控制层组件（如struts中的action）</span><br><span class="line">@Repository 用于标注数据访问组件，即DAO组件。</span><br><span class="line">@Component 泛指组件，当组件不好归类的时候，我们可以使用这个注解进行标注。</span><br><span class="line">@Scope 用于指定scope作用域的（用在类上）</span><br><span class="line">@PostConstruct 用于指定初始化方法（用在方法上）</span><br><span class="line">@PreDestory 用于指定销毁方法（用在方法上）</span><br><span class="line">@DependsOn 定义Bean初始化及销毁时的顺序</span><br><span class="line">@Primary 自动装配时当出现多个Bean候选者时，被注解为@Primary的Bean将作为首选者，否则将抛出异常</span><br><span class="line">@Autowired 默认按类型装配，如果我们想使用按名称装配，可以结合@Qualifier注解一起使用。如下：</span><br><span class="line">@Autowired @Qualifier(&quot;personDaoBean&quot;) 存在多个实例配合使用</span><br><span class="line">@Resource 默认按名称装配，当找不到与名称匹配的bean才会按类型装配。</span><br><span class="line">@Async 异步方法调用</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wforget.github.io/2018/11/08/Netty%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wForget's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/08/Netty%E5%AD%A6%E4%B9%A0/" itemprop="url">Netty学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-08T11:51:38+08:00">
                2018-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Netty学习"><a href="#Netty学习" class="headerlink" title="Netty学习"></a>Netty学习</h2><p>Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。</p>
<blockquote>
<p>官网</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://netty.io/">https://netty.io/</a></p>
<blockquote>
<p>学习参考</p>
</blockquote>
<p>书籍：Netty 实战<br>开源书籍：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://waylau.com/essential-netty-in-action/index.html">Netty 实战(精髓)</a></li>
<li><a target="_blank" rel="noopener" href="https://waylau.com/netty-4-user-guide/">Netty 4.x 用户指南</a></li>
</ul>
<blockquote>
<p>项目代码</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/wForget/NettyDemo">https://github.com/wForget/NettyDemo</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wForget" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangz</span>

  
</div>









        







  <div style="display: none;">
    <script src="//s23.cnzz.com/z_stat.php?id=1276876819&web_id=1276876819" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  





  

  

  

  
  

  

  

  

</body>
</html>
